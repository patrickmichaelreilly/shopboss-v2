@model ShopBoss.Web.Services.TimelineData

@{
    var projectId = Model.Project.Id;
    var timelineId = ViewData["TimelineId"]?.ToString() ?? $"timeline-{projectId}";
}

<div id="@timelineId" class="timeline-container border rounded p-3">
    @if (Model.TaskBlocks.Any() || Model.UnblockedEvents.Any())
    {
        <!-- TaskBlocks with their events (recursive nesting) -->
        @foreach (var block in Model.TaskBlocks)
        {
            ViewData["NestingLevel"] = 0;
            @await Html.PartialAsync("_TaskBlockRecursive", block, ViewData)
        }

        <!-- Unblocked Events -->
        @foreach (var evt in Model.UnblockedEvents)
        {
            <div class="timeline-event unblocked-event" data-event-id="@evt.Id">
                <div class="event-content">
                    <div class="event-header d-flex align-items-center mb-1">
                        <i class="fas fa-grip-vertical event-drag-handle me-2 text-muted" style="cursor: grab; font-size: 0.8em;" title="Drag to assign to block"></i>
                        <div class="event-metadata flex-grow-1">
                            <span class="badge bg-@(evt.EventType == "comment" ? "info" : "secondary") me-1">@evt.EventType</span>
                            @if (evt.RowNumber.HasValue)
                            {
                                <span class="badge bg-primary me-1">Row @evt.RowNumber</span>
                            }
                            <small class="text-muted me-1">@evt.EventDate.ToString("yyyy-MM-dd HH:mm")</small>
                            <small class="text-muted">by @(evt.CreatedBy ?? "Unknown")</small>
                        </div>
                    </div>
                    <div class="event-description">
                        @if (evt.EventType == "attachment" && evt.Attachment != null)
                        {
                            <div class="d-flex align-items-start">
                                <div class="d-flex align-items-center me-3">
                                    <i class="fas fa-paperclip me-1 text-muted"></i>
                                    <a href="/Project/DownloadFile/@evt.Attachment.Id" class="text-decoration-none" title="Download @evt.Attachment.FileName">
                                        <strong>@evt.Attachment.OriginalFileName</strong>
                                    </a>
                                    <small class="text-muted ms-2">
                                        (@((evt.Attachment.FileSize / 1024.0 / 1024.0).ToString("F2")) MB)
                                    </small>
                                </div>
                                @if (evt.Attachment.Category == "SmartSheet Import")
                                {
                                    <div class="ms-auto">
                                        <input type="text" class="form-control form-control-sm" 
                                               style="width: 200px; font-size: 0.8em;" 
                                               value="@evt.Description" 
                                               onblur="updateAttachmentComment('@evt.Id', this.value)"
                                               placeholder="Add comment..."
                                               title="Edit comment for this SmartSheet attachment">
                                    </div>
                                }
                            </div>
                            
                            @if (!string.IsNullOrEmpty(evt.Description) && evt.Attachment.Category != "SmartSheet Import")
                            {
                                <div class="mt-1 text-muted small">@evt.Description</div>
                            }
                        }
                        else
                        {
                            @evt.Description
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center text-muted py-4">
            <i class="fas fa-history fa-2x mb-2"></i>
            <p>No timeline events found</p>
            <small>Events will appear here after SmartSheet data is imported</small>
        </div>
    }
</div>

<style>
    .timeline-event {
        margin-bottom: 4px;
        padding: 2px 0;
    }
    
    .timeline-event .event-content {
        /* No padding needed since we removed the marker */
    }
    
    .timeline-event .event-header {
        margin-bottom: 2px;
    }
    
    .timeline-event .event-metadata {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 2px;
    }
    
    .timeline-event .event-description {
        margin-bottom: 1px;
        line-height: 1.2;
    }
    
    .timeline-event .badge {
        font-size: 0.7em;
    }
    
    .task-block {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background-color: #f8f9fa;
    }
    
    .task-block-header {
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .task-block-header:hover {
        background-color: #e9ecef !important;
    }
    
    .task-block-events {
        background-color: white;
        padding: 8px;
        border-radius: 0 0 6px 6px;
    }
    
    .collapse-icon {
        transition: transform 0.3s ease;
    }
    
    .task-block-header[aria-expanded="false"] .collapse-icon {
        transform: rotate(-90deg);
    }
    
    /* Nesting styles */
    .task-block[data-nesting-level="1"] {
        border-left: 3px solid #007bff;
    }
    
    .task-block[data-nesting-level="2"] {
        border-left: 3px solid #28a745;
    }
    
    .task-block[data-nesting-level="3"] {
        border-left: 3px solid #ffc107;
    }
    
    .nested-task-blocks {
        border-left: 2px solid #dee2e6;
        margin-left: 10px;
        padding-left: 10px;
    }
    
    .section-header {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 4px;
    }
</style>