@model ShopBoss.Web.Models.ProjectEvent
@{
    var projectId = (string?)(ViewData["ProjectId"]) ?? Model.ProjectId;
}

@if (Model.EventType == "work_order" && Model.WorkOrder != null)
{
    <div class="event-primary d-flex align-items-center">
        <i class="fas fa-cog event-icon text-muted" title="Work Order"></i>
        <div>
            @if (!string.IsNullOrEmpty(Model.WorkOrderId))
            {
                <a href="/Admin/ModifyWorkOrder/@Model.WorkOrderId" class="text-decoration-none" title="Open Work Order">
                    <strong>@Model.Description</strong>
                </a>
            }
            else
            {
                <strong>@Model.Description</strong>
            }
            @if (Model.RowNumber.HasValue)
            {
                <span class="badge bg-primary row-badge">Row @Model.RowNumber</span>
            }
            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                    data-action="delete-event" data-project-id="@projectId"
                    data-event-id="@Model.Id"
                    @if (!string.IsNullOrEmpty(Model.WorkOrderId)) { <text>data-wo-id="@Model.WorkOrderId"</text> }
                    title="Delete">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="event-secondary text-muted small mt-1">
        @if (Model.WorkOrder.NestSheets.Any())
        {
            var totalSheets = Model.WorkOrder.NestSheets.Count;
            var cutSheets = Model.WorkOrder.NestSheets.Count(ns => ns.Status >= PartStatus.Cut);
            <div>@cutSheets / @totalSheets Nest Sheets Cut</div>
        }
        @* Intentionally omit date/author line for Work Orders *@
    </div>
}
else if (Model.EventType == "custom_work_order" && Model.CustomWorkOrder != null)
{
    <div class="event-primary d-flex align-items-center">
        <i class="fas fa-clipboard-list event-icon text-muted" title="Custom Work Order"></i>
        <div>
            <strong>@Model.Description</strong>
            @if (Model.RowNumber.HasValue)
            {
                <span class="badge bg-primary row-badge">Row @Model.RowNumber</span>
            }
            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                    data-action="delete-event" data-project-id="@projectId"
                    data-event-id="@Model.Id"
                    data-cwo-id="@Model.CustomWorkOrderId"
                    title="Delete">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="event-secondary text-muted small mt-1">
        @if (!string.IsNullOrEmpty(Model.CustomWorkOrder.Description))
        {
            <div>@Model.CustomWorkOrder.Description</div>
        }
        <div class="event-metadata">@Model.EventDate.ToString("yyyy-MM-dd HH:mm") by @(Model.CreatedBy ?? "Unknown")</div>
    </div>
}
else if (Model.EventType == "comment")
{
    <div class="event-primary d-flex align-items-center">
        <i class="fas fa-comment event-icon text-muted" title="Comment"></i>
        <div>
            <strong>@(Model.Label ?? "Comment")</strong>
            @if (Model.RowNumber.HasValue)
            {
                <span class="badge bg-primary row-badge ms-2">Row @Model.RowNumber</span>
            }
            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                    data-action="delete-event" data-project-id="@projectId"
                    data-event-id="@Model.Id"
                    title="Delete">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="event-secondary text-muted small mt-1">
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <div>@Model.Description</div>
        }
        <div class="event-metadata">@Model.EventDate.ToString("yyyy-MM-dd HH:mm") by @(Model.CreatedBy ?? "Unknown")</div>
    </div>
}
else if (Model.EventType == "purchase_order" && Model.PurchaseOrder != null)
{
    <div class="event-primary d-flex align-items-center">
        <i class="fas fa-shopping-cart event-icon text-muted" title="Purchase Order"></i>
        <div>
            <strong>@Model.Description</strong>
            @if (Model.RowNumber.HasValue)
            {
                <span class="badge bg-primary row-badge">Row @Model.RowNumber</span>
            }
            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                    data-action="delete-event" data-project-id="@projectId"
                    data-event-id="@Model.Id"
                    data-po-id="@Model.PurchaseOrderId"
                    title="Delete">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="event-secondary text-muted small mt-1">
        @if (!string.IsNullOrEmpty(Model.PurchaseOrder.Description))
        {
            <div>@Model.PurchaseOrder.Description</div>
        }
        <div class="event-metadata">@Model.EventDate.ToString("yyyy-MM-dd HH:mm") by @(Model.CreatedBy ?? "Unknown")</div>
    </div>
}
else
{
    <div class="event-primary d-flex align-items-center">
        @if (Model.EventType == "attachment")
        {
            <i class="fas fa-paperclip event-icon text-muted" title="Attachment"></i>
        }
        else
        {
            <i class="fas fa-clipboard-list event-icon text-muted" title="Event"></i>
        }

        <div>
            @if (Model.EventType == "attachment" && Model.Attachment != null)
            {
                <div class="attachment-label-container d-flex align-items-center flex-wrap">
                    <span class="attachment-label editable-label" 
                          data-attachment-id="@Model.Attachment.Id" 
                          data-original-value="@Model.Attachment.Label">@Model.Attachment.Label</span>
                    @if (Model.RowNumber.HasValue)
                    {
                        <span class="badge bg-primary row-badge ms-2">Row @Model.RowNumber</span>
                    }
                    <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                            data-action="delete-event" data-project-id="@projectId"
                            data-event-id="@Model.Id"
                            data-attachment-id="@Model.Attachment.Id"
                            title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            }
            else
            {
                @if (Model.EventType == "work_order" && !string.IsNullOrEmpty(Model.WorkOrderId))
                {
                    <a href="/Admin/ModifyWorkOrder/@Model.WorkOrderId" class="text-decoration-none" title="Open Work Order">
                        <strong>@(String.IsNullOrEmpty(Model.Description) ? Model.EventType : Model.Description.Split('\n')[0])</strong>
                    </a>
                }
                else
                {
                    <strong>@(String.IsNullOrEmpty(Model.Description) ? Model.EventType : Model.Description.Split('\n')[0])</strong>
                }
            @if (Model.RowNumber.HasValue)
            {
                <span class="badge bg-primary row-badge">Row @Model.RowNumber</span>
            }
            }

            @if (Model.EventType != "attachment")
            {
                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2"
                        data-action="delete-event" data-project-id="@projectId"
                        data-event-id="@Model.Id"
                        @if (Model.PurchaseOrderId != null) { <text>data-po-id="@Model.PurchaseOrderId"</text> }
                        @if (Model.CustomWorkOrderId != null) { <text>data-cwo-id="@Model.CustomWorkOrderId"</text> }
                        title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            }
        </div>
    </div>

    <div class="event-secondary text-muted small mt-1">
        @if (Model.EventType == "attachment" && Model.Attachment != null)
        {
            <div class="attachment-details">
                <div class="attachment-file-info">
                    <a href="/Project/DownloadFile/@Model.Attachment.Id" class="text-decoration-none text-muted" title="Download @Model.Attachment.FileName">
                        @Model.Attachment.OriginalFileName
                    </a>
                    <span class="ms-2">@((Model.Attachment.FileSize / 1024.0 / 1024.0).ToString("F2")) MB</span>
                </div>
                <div class="attachment-meta event-metadata">
                    @Model.EventDate.ToString("yyyy-MM-dd HH:mm") by @(Model.CreatedBy ?? "Unknown")
                </div>
            </div>
        }
        else
        {
            @* Standard secondary details for remaining event types *@
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div>@Model.Description</div>
            }
            <div class="event-metadata">@Model.EventDate.ToString("yyyy-MM-dd HH:mm") by @(Model.CreatedBy ?? "Unknown")</div>
        }
    </div>
}
