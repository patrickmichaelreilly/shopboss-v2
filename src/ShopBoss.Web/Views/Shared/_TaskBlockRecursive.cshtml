@model ShopBoss.Web.Models.TaskBlock

@{
    var nestingLevel = ViewData["NestingLevel"] as int? ?? 0;
    var indentClass = nestingLevel > 0 ? $"ms-{Math.Min(nestingLevel * 3, 12)}" : "";
    var blockIcon = "fas fa-cube";
}

<div class="task-block mb-2 @indentClass" data-block-id="@Model.Id" data-nesting-level="@nestingLevel">
    <div class="task-block-header d-flex justify-content-between align-items-center p-2 bg-light border rounded">
        <div class="d-flex align-items-center">
            <div class="chevron-col d-flex align-items-center" 
                 data-bs-toggle="collapse" 
                 data-bs-target="#collapse-@Model.Id" 
                 role="button"
                 style="cursor: pointer;"
                 aria-expanded="true" 
                 aria-controls="collapse-@Model.Id">
                <i class="fas fa-chevron-down collapse-icon text-muted transition-transform" title="Collapse/Expand block"></i>
            </div>
            <div class="d-flex align-items-center">
                <i class="@blockIcon block-icon me-2 text-primary" title="Drag to reorder block"></i>
                <h6 class="mb-0 fw-bold editable-field" 
                    data-block-id="@Model.Id" 
                    data-field="Name" 
                    data-original-value="@Model.Name">@Model.Name</h6>
            </div>
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <small class="text-muted ms-2">â€¢ @Model.Description</small>
            }
            @* Removed event and nested counts for a cleaner header *@
        </div>
        <div class="task-block-toolbox">
            <button class="toolbox-trigger btn btn-sm btn-outline-secondary" title="Actions">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="toolbox-buttons">
                <!-- Block Management Buttons - Trash first for safety -->
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        data-action="delete-task-block" data-block-id="@Model.Id"
                        title="Delete block">
                    <i class="fas fa-trash"></i>
                </button>
                
                <!-- Divider -->
                <div class="toolbox-divider"></div>
                
                <!-- Component Creation Buttons -->
                <button type="button" class="btn btn-outline-primary btn-sm" 
                        data-action="show-upload-file-modal" data-project-id="@Model.ProjectId" data-block-id="@Model.Id"
                        title="Upload File">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" 
                        data-action="show-create-purchase-order" data-project-id="@Model.ProjectId" data-block-id="@Model.Id"
                        title="Add Purchase Order">
                    <i class="fas fa-shopping-cart"></i>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" 
                        data-action="show-associate-work-orders" data-project-id="@Model.ProjectId" data-block-id="@Model.Id"
                        title="Add Manufacturing Work Order">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" 
                        data-action="show-create-custom-work-order" data-project-id="@Model.ProjectId" data-block-id="@Model.Id"
                        title="Add Custom Work Order">
                    <i class="fas fa-clipboard-list"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                        data-action="show-add-comment" data-project-id="@Model.ProjectId" data-block-id="@Model.Id"
                        title="Add Comment">
                    <i class="fas fa-comment"></i>
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" 
                        data-action="create-nested-task-block" data-project-id="@Model.ProjectId" data-block-id="@Model.Id"
                        title="Add Nested Block">
                    <i class="fas fa-cube"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Events and nested blocks within this block (unified container for mixed ordering) -->
    <div class="collapse show" id="collapse-@Model.Id">
        <div class="task-block-content mt-1" data-block-id="@Model.Id">
            @{
                // Get child blocks and events that belong to this block
                var childBlocks = Model.ChildTaskBlocks?.ToList() ?? new List<TaskBlock>();
                
                // Get events from ViewData (all events for the project) that belong to this TaskBlock
                var allEvents = ViewData["AllEvents"] as List<ShopBoss.Web.Models.ProjectEvent> ?? new List<ShopBoss.Web.Models.ProjectEvent>();
                var blockEvents = allEvents.Where(e => e.ParentBlockId == Model.Id).OrderBy(e => e.DisplayOrder).ToList();
                
                // Use the unified timeline container for nested content
                var containerModel = (Blocks: childBlocks, Events: blockEvents, ParentId: Model.Id, NestingLevel: nestingLevel + 1);
            }
            @await Html.PartialAsync("_TimelineContainer", containerModel, ViewData)
        </div>
    </div>
</div>
